<template>
  <div>
    <!-- Information Alert -->
    <Alert class="!mb-6 border-primary/20 bg-primary/5">
      <AlertTitle class="mb-2 flex items-center gap-2 text-xl">
        ๐ถ ูุธุงู ุงูุชุญููู ุงูุฏุงุฎูู ุจุฌุงูุนุฉ ุฃู ุงููุฑู ๐ถ
      </AlertTitle>
      <AlertDescription class="space-y-4 text-base leading-relaxed">
        <p>
          ๐ ููุงุทูุงุน ุนูู ุดุฑูุท ุงูุชุญููู ุญุณุจ ุงููุงุฆุญุฉ ุงููุญุฏุซุฉ:
          <a
            href="https://uqu.edu.sa"
            target="_blank"
            rel="noopener noreferrer"
            class="font-medium text-primary underline-offset-4 hover:underline"
          >
            ุงุถุบุท ููุง
          </a>
        </p>

        <div class="space-y-2">
          <p class="font-bold">๐น ูุนูููุงุช ูููุฉ ุนู ุงูุชุญููู:</p>
          <ul class="space-y-1 pr-4">
            <li>โข ูู ุงูุจุฏุงูุฉุ ุงูุชุฎุตุตุงุช ูุง ุชุทูุจ ูุนุฏู ูุนูู ููุชุญููู.</li>
            <li>
              โข ุงููุณุจ ุงูููุดูุฑุฉ ููุณููุงุช ุงูุณุงุจูุฉ ุชุนุทูู ููุฑุฉ ููุท ุนู ุงููุณุจ ุงููู ุงููุจูุช ููุชูุงุ ููู ูู ุดุฑุท
              ุชููู ุซุงุจุชุฉ.
            </li>
          </ul>
        </div>

        <div class="space-y-2">
          <p class="font-bold">ุนุฏุฏ ุงูููุงุนุฏ ูู ุงูุนุงูู ุงูุฃุณุงุณู ุจุฌุงูุจ ูุฑูุจุฉ ุงูุชุญููู:</p>
          <p class="pr-4">
            ูุซููุงุ ุฅุฐุง ุชุฎุตุต ุงูุฃุญูุงุก ููู 100 ููุนุฏ ุดุงุบุฑ ููุชุญููู ูุชูุฏู ุนููู 400 ุทุงูุจุ ุฑุงุญ ููุจููู ุฃุนูู
            100 ุทุงูุจ ูู ุงููุฑูุจุฉ ููุท. ุฃูู ูุณุจุฉ ูู ุงูููุจูููู ุฑุงุญ ุชูุฐูุฑ ูุงุญููุง ูู ููู ุงููุณุจ. ุงูุจููุฉ
            ููุฑูุถูู ุชููุงุฆููุง.
          </p>
        </div>

        <div class="rounded-md bg-background/50 p-3">
          <p class="font-bold">๐ ุงูุฎูุงุตุฉ:</p>
          <p class="pr-4">
            ูุจููู ูุนุชูุฏ ููููุง ุนูู ูุนุฏูุงุช ุงููุชูุฏููู ูุนู ูุนุฏุฏ ุงูููุงุนุฏ ุงููุชุงุญุฉ ููุชุฎุตุตุ ูู ุนูู ุงููุณุจ
            ุงูุณุงุจูุฉ ุฃู ุฃู ุนุงูู ุขุฎุฑ.
          </p>
        </div>

        <div class="space-y-2">
          <p class="font-bold">๐น ูุง ูู ุงูุชุฎุตุตุงุช ุงููู ุชุธูุฑ ูู ููุช ุงูุชูุฏููุ</p>
          <p class="pr-4">ุชุนุชูุฏ ุนูู ูุณุจุชู ุงูููุฒููุฉ (ุงููู ุฏุฎูุช ูููุง ุงูุฌุงูุนุฉ) ๐ธ ููุถุงู ููุง 5 ุฏุฑุฌุงุช ููุท.</p>
          <div class="rounded-md bg-background/50 p-3">
            <p class="font-bold">๐ง ูุซุงู:</p>
            <p class="pr-4">
              ุฅุฐุง ูุงูุช ููุฒููุชู = 80<br />
              ุฑุงุญ ุชุธูุฑ ูู ุงูุชุฎุตุตุงุช ุงููู ุชุทูุจ ููุฒููุฉ ุฅูู 85<br />
              ููู ุงูุชุฎุตุตุงุช ุงููู ุชุญุชุงุฌ 86 ูููู ูุง ุฑุงุญ ุชุธูุฑ ูู.. ุฅูุง ูู ุงูุนูุงุฏุฉ ูููุช ุงููุณุจ
            </p>
          </div>
        </div>

        <div class="space-y-2">
          <p class="font-bold">โ ุฎุทูุงุช ุทูุจ ุงูุชุญููู:</p>
          <ol class="space-y-1 pr-4">
            <li>1. ุชุฏุฎู ุนูู ุจูุงุจุชู ุงูุฃูุงุฏูููุฉ</li>
            <li>2. ุทูุจุงุช</li>
            <li>3. ุชุฎุชุงุฑ ุทูุจ ุชุบููุฑ ุชุฎุตุต</li>
            <li>4. ุชุญุฏุฏ ูู ุฑุบุจุฉ ูุงุญุฏุฉ ุฅูู ุฎูุณ ุฑุบุจุงุช (ุจุงูุชุฑุชูุจ ุญุณุจ ุฑุบุจุชู)</li>
          </ol>
        </div>

        <div class="space-y-2">
          <p class="font-bold">๐บ ููุงุญุธุงุช ูููุฉ ุฌุฏูุง:</p>
          <ul class="space-y-1 pr-4">
            <li>โข ูุชุงุฆุฌ ุงูุชุญููู ุชุธูุฑ ุจุนุฏ ุงูุชูุงุก ุงูุณูุฉ ุงูุฏุฑุงุณูุฉ ูุงูุชูุงุก ุงูุชุฑู ูุงูููุงุถูุฉ ุจุดูู ูุงูู</li>
            <li>
              โข ุฅุฐุง ุงุนุชุฐุฑุช ุนู ุงูุชุฑู ุงููู ุฑุงุญ ุชูุฏู ููู ุทูุจ ุงูุชุญููู โ ูููุบู ุทูุจ ุงูุชุญููู ุชููุงุฆููุง
            </li>
            <li>
              โข ูุฌุจ ุฃู ูุง ุชููู ุชุฌุงูุฒุช ูุตู ุงูุฎุทุฉ ุงูุฏุฑุงุณูุฉ ุนูุฏ ุชูุฏูู ุทูุจ ุงูุชุญููู.. ุฃู ูู ุฃูุซุฑ ูู ุณูุชูู
              ูู ุงูุฌุงูุนุฉ
            </li>
            <li>โข ูุง ููุฌุฏ ุนุฏูู ูู ุงูุชุญููู ุญุณุจ ุดุฑูุท ุงูุณูุชูู ุงููุงุถูุฉ</li>
          </ul>
        </div>
      </AlertDescription>
    </Alert>

    <!-- Configuration Card -->
    <Card class="!mb-6">
      <CardHeader>
        <CardTitle class="flex items-center gap-2">
          <Icon icon="solar:settings-bold" class="size-5" />
          ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ
        </CardTitle>
      </CardHeader>
      <CardContent class="space-y-4">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <Label for="weighted-percentage">ูุณุจุฉ ุงูููุฒููุฉ (%)</Label>
            <Input
              id="weighted-percentage"
              v-model="weightedPercentage"
              type="number"
              min="0"
              max="100"
              step="0.1"
              placeholder="50"
            />
            <p class="text-xs text-muted-foreground">
              ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: 50% (ุงููุถุฑูุจ ูู ุงูููุฒููุฉ: {{ weightedMultiplier.toFixed(2) }})
            </p>
          </div>
          <div class="space-y-2">
            <Label for="gpa-percentage">ูุณุจุฉ ุงููุนุฏู ุงูุชุฑุงููู (%)</Label>
            <Input
              id="gpa-percentage"
              v-model="gpaPercentage"
              type="number"
              min="0"
              max="100"
              step="0.1"
              placeholder="50"
            />
            <p class="text-xs text-muted-foreground">
              ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: 50% (ุงููุถุฑูุจ ูู ุงููุนุฏู: {{ gpaMultiplier.toFixed(2) }})
            </p>
          </div>
        </div>
        <Button variant="secondary" size="sm" @click="resetToDefaults" class="w-full md:w-auto">
          ุฅุนุงุฏุฉ ุชุนููู ุงูููู ุงูุงูุชุฑุงุถูุฉ
        </Button>
      </CardContent>
    </Card>

    <!-- Calculator Card -->
    <Card class="!mb-6">
      <CardHeader>
        <CardTitle class="flex items-center gap-2">
          <Icon icon="solar:calculator-bold" class="size-5" />
          ุญุณุงุจ ูุฑูุจุฉ ุงูุชุญููู
        </CardTitle>
      </CardHeader>
      <CardContent class="space-y-4">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <Label for="weighted-score">ุงููุณุจุฉ ุงูููุฒููุฉ</Label>
            <Input
              id="weighted-score"
              v-model="weightedScore"
              type="text"
              placeholder="ูุซุงู: 99 ุฃู ูฉูฉ"
            />
            <p class="text-xs text-muted-foreground">ุงููุณุจุฉ ุงูููุฒููุฉ ุงูุชู ููุจูุช ุจูุง ูู ุงูุฌุงูุนุฉ (ูู 100)</p>
          </div>
          <div class="space-y-2">
            <Label for="cumulative-gpa">ุงููุนุฏู ุงูุชุฑุงููู</Label>
            <Input
              id="cumulative-gpa"
              v-model="cumulativeGpa"
              type="text"
              placeholder="ูุซุงู: 3.7 ุฃู ูฃูซูง"
            />
            <p class="text-xs text-muted-foreground">ุงููุนุฏู ุงูุชุฑุงููู ุงูุญุงูู (ูู 4 ุฃู 5)</p>
          </div>
        </div>
      </CardContent>
    </Card>

    <!-- Result Card -->
    <div v-auto-animate>
      <Card v-if="transferScore !== null" class="border-primary/20 bg-primary/5">
        <CardHeader>
          <CardTitle class="flex items-center gap-2">
            <Icon icon="solar:check-circle-bold" class="size-5" />
            ูุชูุฌุฉ ุงูุญุณุงุจ
          </CardTitle>
        </CardHeader>
        <CardContent class="space-y-4">
          <div class="rounded-lg bg-background/80 p-6">
            <p class="mb-2 text-center text-sm text-muted-foreground">ูุฑูุจุฉ ุงูุชุญููู</p>
            <p class="text-center text-4xl font-bold text-primary">
              {{ transferScore.toFixed(2) }}
            </p>
          </div>

          <div class="space-y-3 rounded-lg bg-background/80 p-4">
            <p class="font-bold">๐น ุทุฑููุฉ ุงูุญุณุงุจ:</p>
            <div class="space-y-2 pr-4 text-sm">
              <p>
                โข ุงูููุฒููุฉ: {{ parsedWeightedScore.toFixed(2) }} ร {{ weightedMultiplier.toFixed(2) }} =
                {{ (parsedWeightedScore * weightedMultiplier).toFixed(2) }}
              </p>
              <p>
                โข ุงููุนุฏู ุงูุชุฑุงููู: {{ parsedCumulativeGpa.toFixed(2) }} ร {{ gpaMultiplier.toFixed(2) }} =
                {{ (parsedCumulativeGpa * gpaMultiplier).toFixed(2) }}
              </p>
              <div class="border-t pt-2">
                <p class="font-bold">
                  โข ูุฑูุจุฉ ุงูุชุญููู =
                  {{ (parsedWeightedScore * weightedMultiplier).toFixed(2) }} +
                  {{ (parsedCumulativeGpa * gpaMultiplier).toFixed(2) }} =
                  {{ transferScore.toFixed(2) }}
                </p>
              </div>
            </div>
          </div>

          <Alert>
            <AlertDescription>
              <p class="font-bold">๐ก ุชุฐููุฑ:</p>
              <p class="pr-4 text-sm">
                ูุฐู ุงููุชูุฌุฉ ูู ูุฑูุจุฉ ุงูุชุญููู ุงูุฎุงุตุฉ ุจู. ูุจููู ูู ุงูุชุฎุตุต ูุนุชูุฏ ุนูู ุชุฑุชูุจู ุจูู ุงููุชูุฏููู
                ูุนุฏุฏ ุงูููุงุนุฏ ุงููุชุงุญุฉุ ูููุณ ุนูู ุงููุณุจุฉ ููุท.
              </p>
            </AlertDescription>
          </Alert>
        </CardContent>
      </Card>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref, watch } from 'vue'
import { vAutoAnimate } from '@formkit/auto-animate/vue'
import { toast } from 'vue-sonner'
import { Icon } from '@iconify/vue'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'

// Convert Arabic-Indic digits and separators to a JS number
const parseArabicNumber = (text = '') =>
  parseFloat(
    text
      .trim()
      .replace(/[ู-ูฉ]/g, (digit) => 'ููกูขูฃูคูฅูฆูงูจูฉ'.indexOf(digit) + '')
      .replace(/[ูซุ,]/g, '.')
  ) || 0

// Configuration state
const weightedPercentage = ref('50')
const gpaPercentage = ref('50')

// Input state
const weightedScore = ref('')
const cumulativeGpa = ref('')

// Computed multipliers based on percentages
const weightedMultiplier = computed(() => parseArabicNumber(weightedPercentage.value) / 100)
const gpaMultiplier = computed(() => {
  // Calculate multiplier to make the GPA contribution equal to the percentage
  // If GPA is out of 4, then to get 50 points we need: 4 * x = 50, so x = 12.5
  // But we want it to be percentage-based, so: 4 * x = percentage, so x = percentage / 4
  // However, the standard assumes GPA is out of 4 for 50%, so: x = percentage / 100 * 12.5
  const percentage = parseArabicNumber(gpaPercentage.value)
  return (percentage / 100) * 12.5
})

// Parsed input values
const parsedWeightedScore = computed(() => parseArabicNumber(weightedScore.value))
const parsedCumulativeGpa = computed(() => parseArabicNumber(cumulativeGpa.value))

// Calculate transfer score
const transferScore = computed(() => {
  const weighted = parsedWeightedScore.value
  const gpa = parsedCumulativeGpa.value

  if (weighted <= 0 || gpa <= 0) {
    return null
  }

  return weighted * weightedMultiplier.value + gpa * gpaMultiplier.value
})

// Reset to default values
const resetToDefaults = () => {
  weightedPercentage.value = '50'
  gpaPercentage.value = '50'
  toast.success('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูููู ุงูุงูุชุฑุงุถูุฉ')
}

// Load from localStorage
const loadData = () => {
  if (typeof window !== 'undefined') {
    const stored = localStorage.getItem('transferCalculator')
    if (stored) {
      try {
        const data = JSON.parse(stored)
        weightedPercentage.value = data.weightedPercentage || '50'
        gpaPercentage.value = data.gpaPercentage || '50'
        weightedScore.value = data.weightedScore || ''
        cumulativeGpa.value = data.cumulativeGpa || ''
      } catch (e) {
        console.error('Error loading data:', e)
      }
    }
  }
}

// Save to localStorage
const saveData = () => {
  if (typeof window !== 'undefined') {
    const data = {
      weightedPercentage: weightedPercentage.value,
      gpaPercentage: gpaPercentage.value,
      weightedScore: weightedScore.value,
      cumulativeGpa: cumulativeGpa.value
    }
    localStorage.setItem('transferCalculator', JSON.stringify(data))
  }
}

// Watch for changes and save
watch([weightedPercentage, gpaPercentage, weightedScore, cumulativeGpa], saveData)

// Load on mount
onMounted(() => {
  loadData()
})
</script>

<style scoped>
* {
  margin: 0;
}
</style>
